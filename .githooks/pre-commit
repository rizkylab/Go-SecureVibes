#!/bin/bash

# Pre-commit hook for Go-SecureVibes
# This hook runs before each commit to ensure code quality

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if go is installed
if ! command -v go &> /dev/null; then
    echo -e "${RED}âœ— Go is not installed${NC}"
    exit 1
fi

# 1. Format check
echo -e "\n${YELLOW}1. Checking code formatting...${NC}"
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${RED}âœ— The following files are not formatted:${NC}"
    echo "$UNFORMATTED"
    echo -e "${YELLOW}Run 'make fmt' to format them${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ Code formatting is correct${NC}"

# 2. Go vet
echo -e "\n${YELLOW}2. Running go vet...${NC}"
if ! go vet ./...; then
    echo -e "${RED}âœ— go vet found issues${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ go vet passed${NC}"

# 3. Run tests
echo -e "\n${YELLOW}3. Running tests...${NC}"
if ! go test -short ./...; then
    echo -e "${RED}âœ— Tests failed${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ Tests passed${NC}"

# 4. Check for common issues
echo -e "\n${YELLOW}4. Checking for common issues...${NC}"

# Check for TODO/FIXME in staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
if [ -n "$STAGED_GO_FILES" ]; then
    TODO_COUNT=$(echo "$STAGED_GO_FILES" | xargs grep -n "TODO\|FIXME" || true)
    if [ -n "$TODO_COUNT" ]; then
        echo -e "${YELLOW}âš  Found TODO/FIXME comments:${NC}"
        echo "$TODO_COUNT"
    fi
    
    # Check for fmt.Println (should use logger)
    PRINTLN_COUNT=$(echo "$STAGED_GO_FILES" | xargs grep -n "fmt.Println" || true)
    if [ -n "$PRINTLN_COUNT" ]; then
        echo -e "${YELLOW}âš  Found fmt.Println (consider using logger):${NC}"
        echo "$PRINTLN_COUNT"
    fi
    
    # Check for hardcoded credentials patterns
    CREDS_PATTERN='(password|secret|token|api[_-]?key).*=.*["\047][^"\047]{8,}["\047]'
    CREDS_COUNT=$(echo "$STAGED_GO_FILES" | xargs grep -niE "$CREDS_PATTERN" || true)
    if [ -n "$CREDS_COUNT" ]; then
        echo -e "${RED}âœ— Potential hardcoded credentials found:${NC}"
        echo "$CREDS_COUNT"
        echo -e "${RED}Please remove hardcoded credentials before committing${NC}"
        exit 1
    fi
fi
echo -e "${GREEN}âœ“ No critical issues found${NC}"

# 5. Build check
echo -e "\n${YELLOW}5. Checking if project builds...${NC}"
if ! go build -o /tmp/gosecvibes cmd/gosecvibes/main.go; then
    echo -e "${RED}âœ— Build failed${NC}"
    exit 1
fi
rm -f /tmp/gosecvibes
echo -e "${GREEN}âœ“ Build successful${NC}"

echo -e "\n${GREEN}âœ… All pre-commit checks passed!${NC}"
exit 0
